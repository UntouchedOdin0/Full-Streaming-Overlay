<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Overlay Test</title>
        <link rel="stylesheet" href="./css/main.css">
    </head>

    <body>
        <div id="app"></div>
    </body>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = io(),
            $app = document.getElementById('app'),
            typeElements = {};

        socket.on('update', (data) => {
            let $msg = typeElements[data.type].querySelector(`#${data.type}-msg`);
            let $msgText = typeElements[data.type].querySelector(`#${data.type}-msg-text`);

            let $length = typeElements['length'].querySelector('#length-msg');
            let $lengthText = typeElements['length'].querySelector('#length-msg-text');

            if (data.msg === '' || data.msg === null || data.msg === undefined) {
                data.msg = data.language.empty[data.type]
            }

            $msgText.classList.add('up')
            setTimeout(() => {
                $lengthText.innerText = data.msg;
                // $msg.style.width = msg.offsetWidth;
                $msg.style.width = $length.offsetWidth;
                setTimeout(() => {
                    $msgText.innerText = data.msg;
                    $msgText.classList.remove('up')
                    $msgText.classList.remove('down')
                    setTimeout(() => {
                        $msgText.classList.remove('down')
                    }, 500);
                }, 1000);
            }, 500)
        })

        // Setup sequence
        socket.on('setup', (data) => {
            // Setup text color
            $app.style.color = data.config.overlay.textColor;

            data.config.types.forEach((type) => {
                if (typeElements[type] !== undefined) {
                    return;
                }

                let $typeElement = typeElements[type] = getTypeElement(type, data)

                if (type === 'donation' && data.config.settings.enableTopDonation) {
                    $app.insertAdjacentElement('beforeend', getTypeElement('topDonation', data))
                }

                $app.insertAdjacentElement('beforeend', $typeElement);

            })

            if (typeElements['length'] === undefined) {
                let $lengthElement = typeElements['length'] = document.createElement('div');
                $lengthElement.id = 'length';
                
                let $lengthMsgElement = document.createElement('div')
                $lengthMsgElement.id = 'length-msg';
                $lengthMsgElement.className = 'special inline box msgBox';
                $lengthMsgElement.style.color = 'black';;

                let $lengthMsgSpan = document.createElement('span');
                $lengthMsgSpan.style.overflow = 'hidden';

                let $lengthMsgP = document.createElement('p');
                $lengthMsgP.id = 'length-msg-text';
                $lengthMsgP.className = 'msg';
                $lengthMsgP.innerText = 'placehold';

                $lengthMsgSpan.insertAdjacentElement('beforeend', $lengthMsgP)
                $lengthMsgElement.insertAdjacentElement('beforeend', $lengthMsgSpan)
                $lengthElement.insertAdjacentElement('beforeend', $lengthMsgElement)

                $app.insertAdjacentElement('beforeend', $lengthElement);
            }
        })

        function getTypeElement(type, data)
        {
            let $containerElement = document.createElement('div')
                $containerElement.id = type;
                
            let $parameterElement = document.createElement('id');
            $parameterElement.id = type.concat('-parameter');
            $parameterElement.className = 'special inline box';
            $parameterElement.style.background = data.config.overlay.backgroundColor;

            let $parameterTextElement = document.createElement('span');
            $parameterTextElement.style.overflow = 'hidden';
        
            let $parameterTextElementP = document.createElement('p');
            $parameterTextElementP.id = type.concat('-parameter-text');
            $parameterTextElementP.className = 'parameter';
            $parameterTextElementP.innerText = data.language.labels[type];

            let $messageElement = document.createElement('div');
            $messageElement.id = type.concat('-msg');
            $messageElement.className = 'special inline box msgBox';
            $messageElement.style.background = data.config.overlay.backgroundColor;

            let $messageTextElement = document.createElement('span');
            $messageTextElement.style.overflow = 'hidden';

            let $messageTextElementP = document.createElement('p');
            $messageTextElementP.id = type.concat('-msg-text');
            $messageTextElementP.className = 'msg';
            $messageTextElementP.innerText = data.language.empty[type];

            $messageTextElement.insertAdjacentElement('beforeend', $messageTextElementP)
            $messageElement.insertAdjacentElement('beforeend', $messageTextElement)

            $parameterTextElement.insertAdjacentElement('beforeend', $parameterTextElementP)
            $parameterElement.insertAdjacentElement('beforeend', $parameterTextElement)

            $containerElement.insertAdjacentElement('beforeend', $parameterElement)
            $containerElement.insertAdjacentElement('beforeend', $messageElement)

            return $containerElement;
        }

    </script>
</html>